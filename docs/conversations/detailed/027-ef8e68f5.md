# Conversation: refactored-tumbling-rivest

**Session ID:** `71bd051f-2d7f-45c2-9977-b88b01287b69`
**Agent ID:** `ef8e68f5`
**Started:** 2025-12-03T00:07:47.168Z
**Ended:** 2025-12-03T00:09:59.950Z
**Duration:** 2 minutes

---

### ðŸ¤– Assistant
*6:07:47 PM*

I'll conduct a thorough security audit of this codebase. Let me start by exploring the structure and key security-sensitive files.

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio -type f -name "vercel.json" -o -name ".env*" -o -name "*.config.*" | head -20
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
/Users/ryan/projects/level2bio/vercel.json
/Users/ryan/projects/level2bio/node_modules/@tanstack/react-query/build/query-codemods/eslint.config.js
/Users/ryan/projects/level2bio/node_modules/@tanstack/react-query/build/query-codemods/vite.config.ts
/Users/ryan/projects/level2bio/node_modules/@tanstack/react-query/build/query-codemods/root.eslint.config.js
/Users/ryan/projects/level2bio/.env
/Users/ryan/projects/level2bio/eslint.config.js
/Users/ryan/projects/level2bio/.env.example
/Users/ryan/projects/level2bio/vite.config.ts
/Users/ryan/projects/level2bio/postcss.config.js
```


</details>

### ðŸ¤– Assistant
*6:07:51 PM*

Let me read the critical security files:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/vercel.json`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/.env`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/.env.example`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/vite.config.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/package.json`


</details>

### ðŸ¤– Assistant
*6:07:54 PM*

Now let me examine the Supabase client configuration and logger:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/lib/supabase.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/lib/logger.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/**/*.ts`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/lib/supabase.ts`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/lib/logger.ts`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/lib/utils.ts`
- `/Users/ryan/projects/level2bio/src/types/index.ts`
- `/Users/ryan/projects/level2bio/src/vite-env.d.ts`
- `/Users/ryan/projects/level2bio/src/features/stories/templates.ts`
- `/Users/ryan/projects/level2bio/src/lib/supabase.ts`
- `/Users/ryan/projects/level2bio/src/features/stories/hooks/useStories.ts`
- `/Users/ryan/projects/level2bio/src/features/profile/hooks/useShareLink.ts`
- `/Users/ryan/projects/level2bio/src/features/profile/hooks/useShareLinkMutations.ts`
- `/Users/ryan/projects/level2bio/src/features/profile/index.ts`
- `/Users/ryan/projects/level2bio/src/features/stories/hooks/useStoryMutations.ts`
... and 12 more


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/supabase.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/logger.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/vite-env.d.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/constants.ts`


</details>

### ðŸ¤– Assistant
*6:08:01 PM*

Now let me check for error handling and sensitive data exposure:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Grep**
Search: `console\.(log|error|warn|info|debug)`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Grep**
Search: `throw new Error|alert\(|confirm\(`


</details>

### ðŸ¤– Assistant
*6:08:03 PM*

Let me check more files for error handling and validation:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useAssetUpload.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/validation.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/youtube.ts`


</details>

### ðŸ¤– Assistant
*6:08:07 PM*

Now let me check for Auth-related security issues and route protection:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/**/*Auth*.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/**/*Route*.tsx`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/AuthForm.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/components/AuthForm.tsx`


</details>

### ðŸ¤– Assistant
*6:08:14 PM*

Let me check for any database access patterns and look at public profile access:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/profile/hooks/usePublicProfile.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useStories.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Grep**
Search: `VITE_|import\.meta\.env`


</details>

### ðŸ¤– Assistant
*6:08:18 PM*

Now let me check git history for any secrets that may have been committed:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
git log --oneline -20
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
git log -p --all -S "VITE_SUPABASE_ANON_KEY" | head -50
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
c6dba62 feat: Update logo and add favicon.ico
50e8a7c feat: Add Level2 logo to site
3ec3f82 fix: Update robots.txt to not block homepage indexing
7526f22 feat: Security hardening and Lighthouse improvements
ca89414 docs: Add Claude Code conversation info and token usage to README
3a25d8d feat: Replace chat version with single user-prompts.md
3259f2f feat: Add chat-only version of conversation exports
3913be1 fix: Show note when context was compacted instead of hiding
8f7344d fix: Filter out context continuation summaries from user messages
1ac15e4 fix: Change user icon to ðŸ‘¤
7d01fe6 fix: Improve conversation export formatting
7deb46b feat: Add conversation export script
c77c434 docs: Update hosting to Vercel, mark as shipped
4e4b652 chore: Add Vercel configuration and fix lint errors
9a0029b feat: Add deploy command for Supabase/Vercel deployment
a7540e4 docs: Update documentation with implementation progress
8c41035 Fix best practices, security, and performance issues
7259f87 Shorten 
... (truncated)
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
commit 3a25d8d107aea6ec0256aa24470bead04cbca2b8
Author: ryan321 <ryan321@outlook.com>
Date:   Sat Nov 29 23:09:31 2025 -0600

    feat: Replace chat version with single user-prompts.md
    
    - Removed chat/ directory (individual chat files)
    - Added user-prompts.md with all user-typed messages in one document
    - Each prompt shown with timestamp in blockquote format
    - Grouped by conversation date
    - Skips context continuation summaries
    
    ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
    
    Co-Authored-By: Claude <noreply@anthropic.com>

diff --git a/docs/conversations/chat/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md b/docs/conversations/chat/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md
deleted file mode 100644
index 20fb69b..0000000
--- a/docs/conversations/chat/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md
+++ /dev/null
@@ -1,9188 +0,0 @@
-# Chat: bright-splashing-hammock
-
-**Started:** 2025-11-29T20:55:25.214Z
-**Ended:** 2025-11-30T05:06:47.27
... (truncated)
```


</details>

### ðŸ¤– Assistant
*6:08:21 PM*

Let me check if .env files are in gitignore and look for any exposed secrets:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
cat /Users/ryan/projects/level2bio/.gitignore
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
git log -p --all -S "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" | head -5
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?

# Environment files
.env
.env.local
.env.*.local

# Supabase
.supabase
supabase/.temp
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
commit 3a25d8d107aea6ec0256aa24470bead04cbca2b8
Author: ryan321 <ryan321@outlook.com>
Date:   Sat Nov 29 23:09:31 2025 -0600

    feat: Replace chat version with single user-prompts.md
```


</details>

### ðŸ¤– Assistant
*6:08:26 PM*

Let me check if the secret in the .env file is still valid and check for other potential issues:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "password\|secret\|key\|token" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | grep -v node_modules | grep -i "hard" | head -20
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "http://" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | head -10
```


</details>

### ðŸ¤– Assistant
*6:08:29 PM*

Let me check for CORS and any external API calls:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "cors\|Access-Control\|XMLHttpRequest\|fetch\|axios" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | grep -v node_modules | head -20
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio -name "*.json" -type f | grep -v node_modules | xargs grep -l "cors\|proxy" 2>/dev/null
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
/Users/ryan/projects/level2bio/src/App.tsx:      refetchOnWindowFocus: false,
/Users/ryan/projects/level2bio/src/features/stories/hooks/useStories.ts:        throw new Error(`Failed to fetch stories: ${error.message}`)
/Users/ryan/projects/level2bio/src/features/stories/hooks/useStories.ts:        throw new Error(`Failed to fetch story: ${error.message}`)
/Users/ryan/projects/level2bio/src/features/profile/hooks/useProfiles.ts:        throw new Error(`Failed to fetch profiles: ${error.message}`)
/Users/ryan/projects/level2bio/src/features/profile/hooks/useProfiles.ts:        throw new Error(`Failed to fetch profile: ${error.message}`)
/Users/ryan/projects/level2bio/src/features/profile/hooks/useShareLink.ts:        throw new Error(`Failed to fetch share link: ${error.message}`)
/Users/ryan/projects/level2bio/src/features/profile/hooks/usePublicProfile.ts:        throw new Error(`Failed to fetch profile: ${profileError.message}`)
/Users/ryan/projects/level2bio/src/features/profile/hooks
... (truncated)
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
/Users/ryan/projects/level2bio/vercel.json
```


</details>

### ðŸ¤– Assistant
*6:08:35 PM*

Let me check App.tsx and review the profile and story mutation files more carefully:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/App.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/profile/hooks/useProfileMutations.ts`


</details>

### ðŸ¤– Assistant
*6:08:39 PM*

Let me check the rest of useProfileMutations and look at URL/OAuth handling:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/profile/hooks/useProfileMutations.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "VITE_APP_URL\|window.location\|redirectTo" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | head -20
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx:    const allowedOrigin = import.meta.env.VITE_APP_URL || window.location.origin
/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx:        redirectTo: `${allowedOrigin}/dashboard`,
/Users/ryan/projects/level2bio/src/features/profile/components/ShareLinkManager.tsx:    ? `${window.location.origin}/p/${shareLink.token}`
/Users/ryan/projects/level2bio/src/features/profile/components/ProfileCard.tsx:    () => `${window.location.origin}/p/${profile.share_token}`,
/Users/ryan/projects/level2bio/src/components/ErrorBoundary.tsx:                onClick={() => window.location.href = '/'}
```


</details>

### ðŸ¤– Assistant
*6:08:42 PM*

Let me check the vite-env to ensure VITE_APP_URL is documented and check for any other potential security issues:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "innerHTML\|dangerouslySetInnerHTML\|eval\|Function(" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | head -10
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "localStorage\|sessionStorage" /Users/ryan/projects/level2bio/src --include="*.ts" --include="*.tsx" | head -10
```


</details>

### ðŸ¤– Assistant
*6:08:46 PM*

Let me check dependency versions for known vulnerabilities and check the package-lock or yarn.lock:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
npm audit --audit-level=critical 2>&1 | head -50
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -r "@supabase\|@tanstack\|react\|react-router" /Users/ryan/projects/level2bio/package.json
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
found 0 vulnerabilities
```


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

```
/Users/ryan/projects/level2bio/package.json:    "@supabase/supabase-js": "^2.86.0",
/Users/ryan/projects/level2bio/package.json:    "@tanstack/react-query": "^5.90.11",
/Users/ryan/projects/level2bio/package.json:    "react": "^19.2.0",
/Users/ryan/projects/level2bio/package.json:    "react-dom": "^19.2.0",
/Users/ryan/projects/level2bio/package.json:    "react-markdown": "^10.1.0",
/Users/ryan/projects/level2bio/package.json:    "react-router-dom": "^7.9.6",
/Users/ryan/projects/level2bio/package.json:    "@types/react": "^19.2.5",
/Users/ryan/projects/level2bio/package.json:    "@types/react-dom": "^19.2.3",
/Users/ryan/projects/level2bio/package.json:    "@vitejs/plugin-react": "^5.1.1",
/Users/ryan/projects/level2bio/package.json:    "eslint-plugin-react-hooks": "^7.0.1",
/Users/ryan/projects/level2bio/package.json:    "eslint-plugin-react-refresh": "^0.4.24",
```


</details>

### ðŸ¤– Assistant
*6:08:58 PM*

Let me check the types file to see if there are any sensitive data type definitions, and check the ErrorBoundary:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/index.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/components/ErrorBoundary.tsx`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/components/ErrorBoundary.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/database.ts`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/components/ErrorBoundary.tsx`


</details>

### ðŸ¤– Assistant
*6:09:05 PM*

Now let me check for VITE_APP_URL in the env types and look for the Toast component to check for XSS vulnerabilities:

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep -A 10 "VITE_APP_URL" /Users/ryan/projects/level2bio/src/vite-env.d.ts
```


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Glob**
Pattern: `src/components/Toast.tsx`


</details>

<details>
<summary>ðŸ“¤ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/components/Toast.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/components/Toast.tsx`


</details>

<details>
<summary>ðŸ”§ Tool Calls</summary>

**Tool: Bash**
```bash
grep "VITE_APP_URL" /Users/ryan/projects/level2bio/src/vite-env.d.ts
```


</details>

### ðŸ¤– Assistant
*6:09:59 PM*

Now let me generate a comprehensive security audit report. Based on my findings, I'll create a detailed report:

## Security Audit Report: Level2.bio

I've completed a thorough security audit of the Level2.bio codebase. Below is my detailed analysis with findings, severity levels, and recommendations:

---

### CRITICAL VULNERABILITIES

#### 1. Supabase Anon Key Exposed in Git and .env File
**File**: `/Users/ryan/projects/level2bio/.env`

**Vulnerability**:
- The Supabase anonymous key is stored in plaintext in the `.env` file: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttbXZpd2drZWpqYm1rd2pieG5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NTE5NDMsImV4cCI6MjA4MDAyNzk0M30.EIPt7OORVG_bx55WuQfPeerQ1fr0qOXRcVk0GUZbmTo`
- While `.env` files are properly listed in `.gitignore`, this key is still exposed if:
  - The repository is compromised
  - The server is compromised
  - A developer's machine is compromised

**How It Could Be Exploited**:
- An attacker can use this token to impersonate the application and perform any actions allowed by the Supabase "anon" role (Row-Level Security policies are the only protection)
- The attacker can read/modify/delete any data that lacks proper RLS policies
- Can upload arbitrary files to the Storage bucket if RLS policies are weak
- Can enumerate user data and profile information

**Severity**: CRITICAL

**Recommended Fix**:
1. Immediately rotate this key in the Supabase dashboard
2. Review Supabase RLS policies to ensure they're correctly restricting access (defense in depth)
3. Never store credentials in `.env` files on production servers
4. Use Vercel environment variables for production deployment
5. Implement short expiration times for tokens (the current JWT expires in 2080 - far too long)

**Current Status**: The key is only present in development and the repository, not hardcoded in version control. However, if this key was ever pushed to a public repository, consider it compromised.

---

#### 2. Missing VITE_APP_URL Environment Variable Definition
**File**: `/Users/ryan/projects/level2bio/src/vite-env.d.ts`

**Vulnerability**:
- `VITE_APP_URL` is used in `AuthContext.tsx` line 241 for OAuth redirect validation but is NOT defined in `vite-env.d.ts`
- Without proper typing, it could silently fail, leaving `import.meta.env.VITE_APP_URL` as `undefined`
- Falls back to `window.location.origin`, which could be exploited in certain attack scenarios (open redirect via compromise of redirect chain)

**How It Could Be Exploited**:
```javascript
// AuthContext.tsx line 241
const allowedOrigin = import.meta.env.VITE_APP_URL || window.location.origin
// If VITE_APP_URL is undefined, uses window.location.origin
// On attacker's domain/iframe, this becomes attacker's domain
```

**Severity**: CRITICAL

**Recommended Fix**:
1. Add `VITE_APP_URL` to type definitions in `src/vite-env.d.ts`:
```typescript
interface ImportMetaEnv {
  readonly VITE_SUPABASE_URL: string
  readonly VITE_SUPABASE_ANON_KEY: string
  readonly VITE_USE_MOCK_AUTH: string
  readonly VITE_APP_URL?: string  // Add this
}
```
2. In production, explicitly set `VITE_APP_URL=https://level2.bio` on Vercel
3. Add validation in AuthContext to throw if undefined in production
4. Add environment validation at app startup

---

### HIGH SEVERITY VULNERABILITIES

#### 3. Error Messages Leaking Sensitive Information
**File**: Multiple files (useProfiles.ts, usePublicProfile.ts, useAssetUpload.ts, etc.)

**Vulnerability**:
```typescript
// Examples of exposed error messages:
throw new Error(`Failed to fetch profile: ${profileError.message}`)
throw new Error(`Failed to fetch stories: ${storiesError.message}`)
throw new Error(uploadError.message)
```

These Supabase errors may contain:
- Database error details
- SQL syntax information
- Internal endpoint paths
- Table/column names
- Query patterns

**How It Could Be Exploited**:
- Stack traces visible in browser console (if dev tools opened)
- Error messages passed to UI components and displayed to users
- Attackers can gather schema information from detailed error messages

**Severity**: HIGH

**Recommended Fix**:
1. Implement generic error messages for users:
```typescript
// In usePublicProfile.ts line 25
if (profileError) {
  logger.error('Failed to fetch profile', profileError) // Log full error
  throw new Error('Unable to load profile. Please try again.')  // User sees generic message
}
```
2. Use a utility function to sanitize all error messages
3. Keep detailed logging in development only

---

#### 4. Error Logging in console.error Without Production Safeguards
**File**: `/Users/ryan/projects/level2bio/src/components/ErrorBoundary.tsx` line 24

**Vulnerability**:
```typescript
componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
  console.error('Error caught by boundary:', error, errorInfo)  // Always logs!
}
```

The logger utility (logger.ts) correctly gates dev-only logging, but ErrorBoundary directly uses `console.error()` without checking `isDev`.

**How It Could Be Exploited**:
- Error stack traces are visible in production browser consoles
- Users/attackers with dev tools open can see full error details
- Application internals are exposed

**Severity**: HIGH

**Recommended Fix**:
1. Use the logger utility in ErrorBoundary:
```typescript
import { logger } from '@/lib/logger'

componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
  logger.error('Error caught by boundary', { error, errorInfo })
}
```

---

#### 5. Password Strength Requirements Could Be Stronger
**File**: `/Users/ryan/projects/level2bio/src/features/auth/components/AuthForm.tsx` lines 5-11

**Vulnerability**:
```typescript
const PASSWORD_REQUIREMENTS = {
  minLength: 12,
  hasUppercase: /[A-Z]/,
  hasLowercase: /[a-z]/,
  hasNumber: /[0-9]/,
}
// Missing: No special character requirement
```

While 12 characters is good, OWASP recommends special characters for high-security applications.

**How It Could Be Exploited**:
- Dictionary attacks with 12-character combinations are feasible with modern computing
- Lack of special characters reduces entropy

**Severity**: HIGH

**Recommended Fix**:
Add special character requirement:
```typescript
const PASSWORD_REQUIREMENTS = {
  minLength: 12,
  hasUppercase: /[A-Z]/,
  hasLowercase: /[a-z]/,
  hasNumber: /[0-9]/,
  hasSpecial: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/,
}

function validatePassword(password: string) {
  // ... existing checks ...
  if (!PASSWORD_REQUIREMENTS.hasSpecial.test(password)) {
    return { isValid: false, message: 'Password must contain at least one special character (!@#$%...)' }
  }
  return { isValid: true, message: '' }
}
```

---

#### 6. Potential IDOR in Asset Deletion (Path Traversal Risk)
**File**: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useAssetUpload.ts` lines 180-200

**Vulnerability**:
```typescript
const remove = useCallback(
  async (asset: StoryAsset): Promise<void> => {
    try {
      const url = new URL(asset.url)
      const pathParts = url.pathname.split(`/${BUCKET_NAME}/`)
      const filePath = decodeURIComponent(pathParts[1])  // <-- Decoded from URL
      
      // Validation check exists, but...
      const expectedPrefix = `${userId}/${storyId}/`
      if (!filePath.startsWith(expectedPrefix)) {
        throw new Error('Unauthorized: Cannot delete files outside your story')
      }
```

**Current Risk Assessment**: The code HAS proper validation (defense in depth), so this is mitigated. However:
- The `asset.url` comes from the database which already has the correct path
- Decoding URLs can introduce edge cases with double-encoding, URL fragments, or unusual characters
- The check is path-prefix based and could theoretically be bypassed with carefully crafted paths like:
  - `userId/storyId/../../../otheruser/otherstory/file.jpg`
  - `userId/storyId/..%2f..%2f..%2fotheruser/otherstory/file.jpg`

**Severity**: HIGH (partially mitigated)

**Recommended Fix**:
1. Never construct paths from URL parameters - use database IDs only
2. Validate path segments more strictly:
```typescript
// Better validation
const pathSegments = filePath.split('/')
if (pathSegments.length !== 3) {
  throw new Error('Invalid asset path')
}
const [pathUserId, pathStoryId, fileName] = pathSegments
if (pathUserId !== userId || pathStoryId !== storyId) {
  throw new Error('Unauthorized')
}
// Verify fileName matches expected pattern (UUID or sanitized)
if (!fileName.match(/^\d+-[a-zA-Z0-9_-]+$/)) {
  throw new Error('Invalid filename')
}
```
3. Consider storing file IDs separately from paths in the database

---

### MEDIUM SEVERITY VULNERABILITIES

#### 7. YouTube Video ID Validation Could Allow XSS
**File**: `/Users/ryan/projects/level2bio/src/lib/youtube.ts` lines 33-52

**Vulnerability**:
```typescript
const YOUTUBE_VIDEO_ID_PATTERN = /^[a-zA-Z0-9_-]{11}$/

export function getYouTubeEmbedUrl(videoId: string): string {
  if (!isValidYouTubeVideoId(videoId)) {
    throw new Error(`Invalid YouTube video ID: ${videoId}`)  // Exposes user input in error
  }
  return `https://www.youtube.com/embed/${videoId}`
}
```

**Current Risk Assessment**: The regex validation is CORRECT and prevents injection. The YouTube embed is properly URL-encoded. However:
- The error message exposes user input
- If the validation regex is ever relaxed, XSS becomes possible

**Severity**: MEDIUM

**Recommended Fix**:
1. Don't expose user input in error messages:
```typescript
export function getYouTubeEmbedUrl(videoId: string): string {
  if (!isValidYouTubeVideoId(videoId)) {
    throw new Error('Invalid YouTube video ID')  // Generic message
  }
  return `https://www.youtube.com/embed/${videoId}`
}
```
2. Keep the strict validation regex as-is (it's good)
3. Consider adding a CSP rule for YouTube embeds (already present in vercel.json - good!)

---

#### 8. CSP Header Configuration Could Be More Restrictive
**File**: `/Users/ryan/projects/level2bio/vercel.json` lines 29-30

**Vulnerability**:
```json
"Content-Security-Policy": "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' https: data: blob:; font-src 'self'; connect-src 'self' https://*.supabase.co wss://*.supabase.co; media-src 'self' https://*.supabase.co blob:; frame-src https://www.youtube.com https://youtube.com; ..."
```

Issues:
- `style-src 'unsafe-inline'` - allows inline CSS, potential for CSS injection attacks
- `img-src https:` - allows images from ANY HTTPS domain (should be restricted)
- `connect-src 'self' https://*.supabase.co` - correct, but verify no other APIs are used

**How It Could Be Exploited**:
- CSS injection can be used for keylogging or phishing (CSS exfiltration)
- Image URLs could be used for HTTP requests to unintended destinations

**Severity**: MEDIUM

**Recommended Fix**:
```json
{
  "key": "Content-Security-Policy",
  "value": "default-src 'self'; script-src 'self'; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: blob: https://kmmviwgkejjbmkwjbxnf.supabase.co; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://kmmviwgkejjbmkwjbxnf.supabase.co wss://kmmviwgkejjbmkwjbxnf.supabase.co; media-src 'self' https://kmmviwgkejjbmkwjbxnf.supabase.co blob:; frame-src https://www.youtube.com; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests;"
}
```

Key improvements:
- Remove `'unsafe-inline'` from style-src (use external stylesheets only)
- Restrict img-src to specific Supabase bucket domain
- Remove wildcard from connect-src (use exact domain)
- Add font-src restrictions

---

#### 9. Token Expiration Not Enforced on Stored JWTs
**File**: The Supabase anon key JWT expires in 2080 (see token claim in .env)

**Vulnerability**:
```
JWT payload: {"iss":"supabase","ref":"kmmviwgkejjbmkwjbxnf","role":"anon","iat":1764451943,"exp":2080027943}
```
Token expires in year 2080 - 54+ years from now!

**How It Could Be Exploited**:
- If the key is ever leaked, it has a very long window of exposure
- Long-lived tokens can't be easily rotated without breaking existing deployments
- Industry standard is months, not decades

**Severity**: MEDIUM

**Recommended Fix**:
1. Contact Supabase support to regenerate the anon key with a reasonable expiration
2. Implement token rotation policy (annual key rotation minimum)
3. Add monitoring to detect unusual API usage patterns
4. Consider using short-lived access tokens with refresh tokens (Supabase Auth handles this)

---

#### 10. Missing Supabase RLS Policies (Not Visible in Code)
**File**: Database configuration (not provided in codebase review)

**Vulnerability**:
I cannot verify if Row-Level Security (RLS) policies are properly configured on:
- `work_stories` table (should only be accessible by owner or public profiles)
- `profiles` table (should only be editable by owner)
- `profile_stories` table (should only be accessible by owner)

Without RLS, the Supabase anon key vulnerability becomes CRITICAL instead of just HIGH.

**Severity**: MEDIUM (Unverified)

**Recommended Actions**:
1. Ensure ALL tables have RLS enabled with policies:
   - `work_stories`: SELECT own records + SELECT public profile records
   - `profiles`: SELECT own/public records, UPDATE/DELETE own only
   - `profile_stories`: SELECT own/public records, UPDATE/DELETE own only
   - `users`: SELECT own record, UPDATE own record only
2. Test RLS policies with the anon key to verify enforcement
3. Document all RLS policies in `docs/database-security.md`

---

### LOW SEVERITY VULNERABILITIES

#### 11. Console Logging in Development
**File**: `/Users/ryan/projects/level2bio/src/lib/logger.ts`

**Vulnerability**:
The logger correctly prevents logging in production, but during development:
- Sensitive data could be accidentally logged via `logger.debug()`, `logger.info()`
- Browser console is visible in developer tools

**Severity**: LOW (development only)

**Recommended Fix**:
Add data sanitization to logger:
```typescript
export const logger = {
  debug: (...args: unknown[]) => {
    if (isDev) {
      // Sanitize sensitive fields
      const sanitized = args.map(arg => {
        if (typeof arg === 'object' && arg !== null) {
          const obj = { ...arg }
          // Remove sensitive keys
          delete (obj as any).password
          delete (obj as any).token
          delete (obj as any).secret
          delete (obj as any).key
          return obj
        }
        return arg
      })
      console.log('[DEBUG]', ...sanitized)
    }
  },
  // ... rest of logger
}
```

---

#### 12. Missing API Rate Limiting
**File**: Application level (not implemented)

**Vulnerability**:
No rate limiting on:
- Profile creation (could spam profiles)
- Story uploads (could fill storage)
- Token regeneration (could be brute-forced)
- Public profile views (DDoS vector)

**Severity**: LOW (Supabase may have built-in rate limiting)

**Recommended Fix**:
1. Verify Supabase has rate limiting enabled in dashboard
2. Implement client-side rate limiting:
   - Max 5 profiles per user
   - Max 100 stories per user
   - Max 1 token regeneration per minute
3. Add request deduplication in React Query

---

#### 13. Missing X-Content-Type-Options Header on Storage Files
**File**: Supabase Storage (not Vercel-level control)

**Vulnerability**:
Files uploaded to Supabase Storage may not have proper Content-Type headers. PDFs served as `application/octet-stream` instead of `application/pdf` could trigger downloads instead of preview.

**Severity**: LOW

**Recommended Fix**:
1. Set proper Content-Type on upload in `useAssetUpload.ts`:
```typescript
const { error: uploadError } = await supabase.storage
  .from(BUCKET_NAME)
  .upload(filePath, file, {
    cacheControl: '3600',
    upsert: false,
    contentType: file.type,  // Add this
  })
```

---

#### 14. Missing Subresource Integrity (SRI) for External Resources
**File**: `/Users/ryan/projects/level2bio/vite.config.ts` and HTML

**Vulnerability**:
If any external scripts or stylesheets are loaded (Tailwind fonts, etc.), they lack SRI hashes.

**Severity**: LOW (minor attack surface)

---

### BEST PRACTICES ISSUES

#### 15. Missing Secrets Scanning
**Recommendation**: Add pre-commit hooks to prevent credential commits:

```bash
# Install git-secrets or similar
npm install --save-dev husky
npm install --save-dev git-secrets

# In .husky/pre-commit:
#!/bin/sh
git secrets --pre_commit_hook
```

#### 16. Missing Monitoring/Alerting
The codebase has TODOs for error monitoring (Sentry) that should be implemented for production.

#### 17. Missing CORS Configuration
Vercel doesn't have explicit CORS headers. Ensure Supabase dashboard has CORS properly configured for your domain.

---

## Summary Table

| # | Issue | Severity | Status | Fix Priority |
|---|-------|----------|--------|--------------|
| 1 | Supabase Anon Key Exposure | CRITICAL | Exposed in repo | IMMEDIATE |
| 2 | Missing VITE_APP_URL Type | CRITICAL | Untyped env var | IMMEDIATE |
| 3 | Error Messages Leak Info | HIGH | Throughout codebase | HIGH |
| 4 | Unguarded console.error | HIGH | ErrorBoundary.tsx | HIGH |
| 5 | Weak Password Requirements | HIGH | AuthForm.tsx | HIGH |
| 6 | Asset Deletion Path Traversal | HIGH | Partially mitigated | MEDIUM |
| 7 | YouTube ID Error Messages | MEDIUM | youtube.ts | MEDIUM |
| 8 | CSP Too Permissive | MEDIUM | vercel.json | MEDIUM |
| 9 | Long-lived JWT Tokens | MEDIUM | Supabase config | MEDIUM |
| 10 | RLS Policies Unknown | MEDIUM | Unverified | HIGH |
| 11 | Dev Console Logging | LOW | logger.ts | LOW |
| 12 | No Rate Limiting | LOW | Application level | LOW |
| 13 | Missing Content-Type Headers | LOW | Storage uploads | LOW |
| 14 | No SRI for External Resources | LOW | HTML/Config | LOW |

---

## Positive Security Observations

1. **Excellent error message sanitization in AuthContext** - Properly hides auth-related error details from users
2. **Strong file upload validation** - Magic number checking prevents file type spoofing
3. **Good file path validation** - Defense-in-depth approach to asset deletion
4. **Security headers well-configured** - HSTS, X-Frame-Options, Referrer-Policy all set correctly
5. **No dangerous DOM operations** - No innerHTML, dangerouslySetInnerHTML, or eval
6. **Proper routing protection** - ProtectedRoute component guards authenticated pages
7. **HTTPS enforcement** - upgrade-insecure-requests header enabled
8. **Clean code structure** - Security concerns properly separated

---

## Next Steps

1. **Immediately rotate the Supabase anon key** (CRITICAL)
2. **Add VITE_APP_URL to type definitions** (CRITICAL)
3. **Implement generic error messages** throughout hooks (HIGH)
4. **Add special character requirement to passwords** (HIGH)
5. **Add error logging without console.error in ErrorBoundary** (HIGH)
6. **Verify and document RLS policies** (HIGH)
7. **Tighten CSP headers** (MEDIUM)
8. **Implement Sentry or similar monitoring** (MEDIUM)
9. **Add pre-commit hooks for secrets detection** (MEDIUM)
10. **Document security configuration** in a SECURITY.md file (MEDIUM)
