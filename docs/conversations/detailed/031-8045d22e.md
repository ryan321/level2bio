# Conversation: refactored-tumbling-rivest

**Session ID:** `71bd051f-2d7f-45c2-9977-b88b01287b69`
**Agent ID:** `8045d22e`
**Started:** 2025-12-03T00:20:57.982Z
**Ended:** 2025-12-03T00:23:37.516Z
**Duration:** 3 minutes

---

### ü§ñ Assistant
*6:20:57 PM*

I'll conduct a comprehensive XSS security audit of this codebase, focusing on the critical areas you've identified.

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/components/RichMarkdown.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/components/YouTubeEmbed.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Glob**
Pattern: `src/features/stories/components/*.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Glob**
Pattern: `src/features/profile/components/*.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx`


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/features/profile/components/ProfileManager.tsx`
- `/Users/ryan/projects/level2bio/src/features/profile/components/CreateProfileForm.tsx`
- `/Users/ryan/projects/level2bio/src/features/profile/components/ShareLinkManager.tsx`
- `/Users/ryan/projects/level2bio/src/features/profile/components/ProfileCard.tsx`


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/features/stories/components/AssetUploader.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/TemplateSelector.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/StoryList.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/StoryEditor.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/StoryCard.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/MarkdownEditor.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/components/StoryCard.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/components/StoryEditor.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/components/MarkdownEditor.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/profile/components/ProfileCard.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/youtube.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `dangerouslySetInnerHTML`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `rehypeRaw|rehype-raw`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `sanitize|DOMPurify`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/package.json`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Glob**
Pattern: `src/**/*.tsx`


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `docs/conversations/detailed/018-783d216e.md`
- `docs/conversations/detailed/015-65322f69.md`
- `docs/conversations/detailed/010-b28c1bbb.md`
- `docs/conversations/detailed/005-cbe410dd.md`
- `docs/conversations/detailed/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md`


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `src/features/auth/AuthContext.tsx`
- `CLAUDE.md`
- `docs/conversations/detailed/020-8fe51442.md`
- `docs/conversations/detailed/015-65322f69.md`
- `docs/conversations/detailed/012-037a40d3.md`
- `docs/conversations/detailed/011-538c9a84.md`
- `docs/conversations/detailed/010-b28c1bbb.md`
- `docs/conversations/detailed/008-9c9aa364.md`
- `docs/conversations/detailed/005-cbe410dd.md`
- `docs/conversations/detailed/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md`
... and 4 more


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `/Users/ryan/projects/level2bio/src/main.tsx`
- `/Users/ryan/projects/level2bio/src/pages/NotFound.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx`
- `/Users/ryan/projects/level2bio/src/components/Dialog.tsx`
- `/Users/ryan/projects/level2bio/src/features/profile/components/ProfileManager.tsx`
- `/Users/ryan/projects/level2bio/src/features/stories/components/AssetUploader.tsx`
- `/Users/ryan/projects/level2bio/src/App.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/AuthForm.tsx`
... and 17 more


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `href=\{.*\}`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `src=\{.*\}`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useAssetUpload.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/components/Dialog.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/pages/Home.tsx`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `innerHTML|createMarkup`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/index.ts`


</details>

<details>
<summary>üì§ Tool Output</summary>

Found files:
- `docs/conversations/detailed/018-783d216e.md`
- `docs/conversations/detailed/015-65322f69.md`
- `docs/conversations/detailed/010-b28c1bbb.md`
- `docs/conversations/detailed/005-cbe410dd.md`
- `docs/conversations/detailed/003-ed53f46a-1264-4cf5-bd8c-07aba30981cd.md`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/database.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio/src -name "*.tsx" -o -name "*.ts" | wc -l
```


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `eval\(|Function\(|setTimeout\(.*string|setInterval\(.*string`


</details>

<details>
<summary>üì§ Tool Output</summary>

```
      49
```


</details>

### ü§ñ Assistant
*6:21:39 PM*

Now let me check if there are any React Router Link components that could potentially use user data in `to` attributes:

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `&lt;Link.*to=\{`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `&lt;a.*href=`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/vite.config.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Bash**
```bash
grep -n "href=" /Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx
```


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Bash**
```bash
grep -n "to=" /Users/ryan/projects/level2bio/src/features/stories/components/StoryCard.tsx
```


</details>

<details>
<summary>üì§ Tool Output</summary>

```
88:            href="/"
170:      href={asset.url}
```


</details>

<details>
<summary>üì§ Tool Output</summary>

```
35:            to={ROUTES.STORY_EDITOR.replace(':id', story.id)}
```


</details>

### ü§ñ Assistant
*6:21:52 PM*

Perfect! Now let me check the ROUTES constant and look at how user profile photo URLs are handled:

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/constants.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `profile_photo_url`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`


</details>

### ü§ñ Assistant
*6:22:03 PM*

Let me check where the profile photo URL comes from in OAuth:

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`


</details>

### ü§ñ Assistant
*6:22:07 PM*

Now let me check what the CSP headers are and look at the validation library:

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/validation.ts`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Grep**
Search: `Content-Security-Policy|CSP`


</details>

<details>
<summary>üîß Tool Calls</summary>

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/vercel.json`


</details>

### ü§ñ Assistant
*6:23:37 PM*

Perfect! Now I have a comprehensive view of the codebase. Let me create the security audit report:

---

# XSS Security Audit Report
**Level2.bio React/TypeScript Application**

## Executive Summary

This codebase demonstrates **strong security posture** against XSS attacks. The application has implemented multiple defense-in-depth layers including protocol validation, markdown-only rendering (no HTML), Content Security Policy headers, and input sanitization. 

**Overall Risk Level: LOW** ‚úÖ

I found **2 medium-severity issues** and **2 low-severity recommendations**. No critical or high-severity XSS vulnerabilities were discovered.

---

## Critical Areas Reviewed

### 1. ‚úÖ Markdown Rendering (HIGHEST PRIORITY)

**File**: `/Users/ryan/projects/level2bio/src/components/RichMarkdown.tsx`

**Status**: SECURE ‚úÖ

**Analysis**:
- Uses `react-markdown` v10.1.0 WITHOUT `rehypeRaw` plugin
- **No raw HTML is allowed** - markdown is parsed and rendered as React components only
- Custom component overrides for `<a>` and `<img>` tags with security validation
- Protocol validation prevents `javascript:` URLs
- YouTube video IDs are strictly validated with regex pattern: `/^[a-zA-Z0-9_-]{11}$/`

**Security Controls**:
```typescript
// Protocol whitelist prevents javascript: URLs
const ALLOWED_LINK_PROTOCOLS = ['http:', 'https:', 'mailto:']
const ALLOWED_IMAGE_PROTOCOLS = ['https:', 'http:', 'data:']

// Validation function
function isAllowedProtocol(url: string, allowedProtocols: string[]): boolean {
  try {
    const parsed = new URL(url, 'https://example.com')
    return allowedProtocols.includes(parsed.protocol)
  } catch {
    return false
  }
}
```

**Why This Is Secure**:
- react-markdown by default escapes HTML characters
- User input like `<script>alert('xss')</script>` becomes plain text, not executed
- No `dangerouslySetInnerHTML` usage anywhere in the codebase

---

### 2. ‚ö†Ô∏è User-Generated Content Display

#### a) **Story Content** (responses field) - SECURE ‚úÖ

**Files**: 
- `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx` (lines 126-128)
- `/Users/ryan/projects/level2bio/src/features/stories/components/MarkdownEditor.tsx`

**Status**: SECURE - All story content passes through RichMarkdown component

```typescript
// PublicProfilePage.tsx - Line 127
<RichMarkdown>{response}</RichMarkdown>
```

#### b) **Profile Bio and Headline** - MEDIUM SEVERITY ‚ö†Ô∏è

**File**: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx`

**Vulnerable Code** (Lines 54-61):
```typescript
{displayHeadline && (
  <p className="text-gray-600">{displayHeadline}</p>
)}
...
{displayBio && (
  <p className="mt-4 text-gray-700">{displayBio}</p>
)}
```

**Severity**: MEDIUM

**Risk**: While React automatically escapes string values in JSX (preventing direct XSS), these fields accept any user input without markdown rendering. If these fields were ever rendered using `dangerouslySetInnerHTML` or processed differently, they could become attack vectors.

**Attack Scenario**:
Currently NOT exploitable due to React's auto-escaping, but:
1. User sets headline to: `<img src=x onerror=alert('xss')>`
2. React renders it as text: `&lt;img src=x onerror=alert('xss')&gt;`
3. **Currently safe**, but brittle if code changes

**Validation Status**: 
- Length validation exists (headline: 200 chars, bio: 2000 chars)
- NO content validation or sanitization
- NO markdown rendering (inconsistent with story content)

**Fix**: Apply markdown rendering to these fields for consistency:
```typescript
{displayHeadline && (
  <div className="text-gray-600 prose-sm">
    <RichMarkdown>{displayHeadline}</RichMarkdown>
  </div>
)}
{displayBio && (
  <div className="mt-4 text-gray-700 prose-sm">
    <RichMarkdown>{displayBio}</RichMarkdown>
  </div>
)}
```

**OR** implement explicit HTML escaping as a defense-in-depth measure.

#### c) **User Names** - MEDIUM SEVERITY ‚ö†Ô∏è

**File**: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx`

**Vulnerable Code** (Lines 48, 53, 63):
```typescript
<span className="text-2xl font-semibold text-blue-600">
  {user.name.charAt(0).toUpperCase()}
</span>
<h1 className="text-2xl font-bold">{user.name}</h1>
{user.name.split(' ')[0]} has shared...
```

**Severity**: MEDIUM

**Risk**: User names from OAuth providers (LinkedIn) are trusted without validation. If an attacker could manipulate their OAuth profile name, XSS is possible.

**Attack Scenario**:
1. Attacker modifies LinkedIn profile name to: `<img src=x onerror=alert(document.cookie)>`
2. Signs up via LinkedIn OAuth
3. Creates a public profile
4. Shares link with victim
5. **Currently safe** due to React auto-escaping, but no validation exists

**Source**: `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx` (line 178)
```typescript
name: defaultName,  // From authUser.name (OAuth metadata)
```

**Fix**: Validate and sanitize user names on account creation:
```typescript
function sanitizeName(name: string): string {
  // Remove any HTML-like characters
  return name
    .replace(/[<>]/g, '')
    .trim()
    .slice(0, 100) // Max length
}

const sanitizedName = sanitizeName(authUser.name)
```

---

### 3. ‚úÖ URL Handling

#### a) **YouTube Embed URLs** - SECURE ‚úÖ

**File**: `/Users/ryan/projects/level2bio/src/lib/youtube.ts`

**Security Controls**:
1. **Video ID extraction** with strict regex (lines 14-16):
```typescript
const patterns = [
  /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
]
```

2. **Video ID validation** (lines 34-41):
```typescript
const YOUTUBE_VIDEO_ID_PATTERN = /^[a-zA-Z0-9_-]{11}$/

export function isValidYouTubeVideoId(videoId: string): boolean {
  return YOUTUBE_VIDEO_ID_PATTERN.test(videoId)
}
```

3. **Embed URL construction** (lines 47-52):
```typescript
export function getYouTubeEmbedUrl(videoId: string): string {
  if (!isValidYouTubeVideoId(videoId)) {
    throw new Error(`Invalid YouTube video ID: ${videoId}`)
  }
  return `https://www.youtube.com/embed/${videoId}`
}
```

**Status**: SECURE - No way to inject `javascript:` or malicious URLs.

#### b) **Asset URLs from Supabase Storage** - SECURE ‚úÖ

**File**: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx` (line 170)

```typescript
<a
  href={asset.url}
  download={asset.name}
  target="_blank"
  rel="noopener noreferrer"
>
```

**Analysis**:
- Asset URLs are generated by Supabase Storage (trusted source)
- URLs follow pattern: `https://{project}.supabase.co/storage/v1/object/public/story-assets/{path}`
- No user control over URL construction
- `rel="noopener noreferrer"` prevents window.opener exploitation

**Potential Risk**: Asset NAME is user-controlled. Let me check escaping...

**File**: `/Users/ryan/projects/level2bio/src/features/stories/components/MarkdownEditor.tsx` (lines 88-95)

```typescript
// Security: Escape markdown special characters in asset name to prevent injection
const escapedName = asset.name
  .replace(/\\/g, '\\\\')  // Escape backslashes first
  .replace(/\[/g, '\\[')   // Escape opening brackets
  .replace(/\]/g, '\\]')   // Escape closing brackets
  .replace(/\(/g, '\\(')   // Escape opening parens
  .replace(/\)/g, '\\)')   // Escape closing parens
  .replace(/!/g, '\\!')    // Escape exclamation marks
```

**Status**: SECURE ‚úÖ - Asset names are escaped before markdown insertion.

#### c) **Profile Photo URLs** - LOW SEVERITY ‚ö†Ô∏è

**File**: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx` (line 41)

```typescript
<img
  src={user.profile_photo_url}
  alt={user.name}
  className="w-16 h-16 rounded-full object-cover"
/>
```

**Risk**: `profile_photo_url` comes from LinkedIn OAuth metadata (untrusted source). While React prevents `javascript:` URLs in `src`, data URLs with SVG could execute scripts.

**Attack Scenario**:
1. Attacker sets LinkedIn profile photo to data URL with embedded SVG
2. SVG contains `<script>` tag
3. When rendered as `<img src="data:image/svg+xml,<svg>...">`, script executes

**Likelihood**: LOW - Modern browsers block script execution in `<img>` SVG data URLs, but older browsers may be vulnerable.

**Fix**: Validate profile photo URLs:
```typescript
function isValidImageUrl(url: string | null): boolean {
  if (!url) return false
  try {
    const parsed = new URL(url)
    // Only allow HTTPS URLs from trusted domains
    return parsed.protocol === 'https:' && 
           (parsed.hostname.endsWith('.licdn.com') || 
            parsed.hostname.endsWith('.supabase.co'))
  } catch {
    return false
  }
}

// In render:
{user.profile_photo_url && isValidImageUrl(user.profile_photo_url) ? (
  <img src={user.profile_photo_url} ... />
) : (
  <div className="w-16 h-16 rounded-full bg-blue-100">...</div>
)}
```

---

### 4. ‚úÖ React-Specific Checks

#### a) **dangerouslySetInnerHTML** - NOT USED ‚úÖ

**Search Results**: Only found in old conversation docs, not in actual source code.

#### b) **Dynamic href Attributes** - SECURE ‚úÖ

All `href` attributes use static values or validated URLs:
- Line 88 (`href="/"`) - static
- Line 170 (`href={asset.url}`) - Supabase-generated URL

#### c) **Dynamic src Attributes** - ADDRESSED ABOVE ‚ö†Ô∏è

See profile photo URL issue (#3c).

---

### 5. ‚úÖ File Upload Security

**File**: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useAssetUpload.ts`

**Security Controls**:

1. **File Type Validation** (lines 9-18):
```typescript
const ALLOWED_TYPES: Record<string, AssetType> = {
  'image/jpeg': 'image',
  'image/png': 'image',
  'image/gif': 'image',
  'image/webp': 'image',
  'video/mp4': 'video',
  'video/webm': 'video',
  'video/quicktime': 'video',
  'application/pdf': 'pdf',
}
```

2. **Magic Number Validation** (lines 20-59):
```typescript
const FILE_SIGNATURES: Record<string, number[][]> = {
  'image/jpeg': [[0xFF, 0xD8, 0xFF]],
  'image/png': [[0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A]],
  // ... etc
}

async function validateFileSignature(file: File): Promise<boolean> {
  // Validates actual file content matches declared MIME type
}
```

3. **File Size Limit** (lines 6-7, 114-118):
```typescript
const MAX_FILE_SIZE_MB = 50
const MAX_FILE_SIZE = MAX_FILE_SIZE_MB * 1024 * 1024

if (file.size > MAX_FILE_SIZE) {
  const err = `File is too large. Maximum size is ${MAX_FILE_SIZE_MB}MB.`
  setError(err)
  throw new Error(err)
}
```

4. **Filename Sanitization** (lines 85-89):
```typescript
function generateFilePath(userId: string, storyId: string, fileName: string): string {
  const timestamp = Date.now()
  const sanitizedName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_')
  return `${userId}/${storyId}/${timestamp}-${sanitizedName}`
}
```

**Status**: SECURE ‚úÖ - Comprehensive validation prevents malicious file uploads.

---

### 6. ‚úÖ Content Security Policy (CSP)

**File**: `/Users/ryan/projects/level2bio/vercel.json` (line 29-30)

```
Content-Security-Policy: 
  default-src 'self'; 
  script-src 'self'; 
  style-src 'self' 'unsafe-inline'; 
  img-src 'self' https: data: blob:; 
  font-src 'self'; 
  connect-src 'self' https://*.supabase.co wss://*.supabase.co; 
  media-src 'self' https://*.supabase.co blob:; 
  frame-src https://www.youtube.com https://youtube.com; 
  frame-ancestors 'none'; 
  base-uri 'self'; 
  form-action 'self'; 
  upgrade-insecure-requests;
```

**Analysis**:

‚úÖ **Strengths**:
- `script-src 'self'` - blocks inline scripts and external JS
- `frame-src` limited to YouTube only
- `frame-ancestors 'none'` - prevents clickjacking
- `base-uri 'self'` - prevents base tag injection
- `form-action 'self'` - prevents form hijacking

‚ö†Ô∏è **Weaknesses**:
- `style-src 'self' 'unsafe-inline'` - allows inline styles (needed for Tailwind)
- `img-src https: data: blob:` - allows all HTTPS images (overly permissive)

**Recommendation**: Tighten `img-src` to specific domains:
```
img-src 'self' https://*.supabase.co https://*.licdn.com data: blob:;
```

---

### 7. ‚úÖ Additional Security Checks

#### a) **No eval() or Function() Usage** ‚úÖ
Grep search returned no results - code does not use dynamic code execution.

#### b) **Input Validation** ‚úÖ
All user inputs have length validation (`/Users/ryan/projects/level2bio/src/lib/validation.ts`):
- Profile name: 1-100 chars
- Headline: max 200 chars
- Bio: max 2000 chars
- Story title: 1-200 chars
- Story response: max 10,000 chars

#### c) **React Auto-Escaping** ‚úÖ
All user content rendered as JSX children (automatically escaped by React):
```typescript
<h1>{user.name}</h1>  // React escapes this
```

---

## Summary of Findings

| Severity | Issue | File | Line | Fix Priority |
|----------|-------|------|------|--------------|
| MEDIUM | Profile headline/bio not markdown-rendered | PublicProfilePage.tsx | 54-61 | Medium |
| MEDIUM | User names from OAuth not validated | AuthContext.tsx | 178 | Medium |
| LOW | Profile photo URL from OAuth not validated | PublicProfilePage.tsx | 41 | Low |
| LOW | CSP img-src too permissive | vercel.json | 29 | Low |

---

## Recommendations

### Immediate Actions (Medium Priority)

1. **Validate OAuth User Names** (`/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`):
```typescript
function sanitizeName(name: string): string {
  return name
    .replace(/[<>"']/g, '')  // Remove potential XSS chars
    .trim()
    .slice(0, 100)
}

// Line 178
name: sanitizeName(defaultName),
```

2. **Apply Markdown Rendering to Bio/Headline** (`/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx`):
```typescript
{displayHeadline && (
  <div className="text-gray-600 prose prose-sm">
    <RichMarkdown>{displayHeadline}</RichMarkdown>
  </div>
)}
```

### Long-Term Improvements (Low Priority)

3. **Validate Profile Photo URLs**:
```typescript
// Add to src/lib/validation.ts
export function isValidImageUrl(url: string | null): boolean {
  if (!url) return false
  try {
    const parsed = new URL(url)
    return parsed.protocol === 'https:' && 
           (parsed.hostname.endsWith('.licdn.com') || 
            parsed.hostname.endsWith('.supabase.co'))
  } catch {
    return false
  }
}
```

4. **Tighten CSP img-src** (`/Users/ryan/projects/level2bio/vercel.json`):
```json
"img-src 'self' https://*.supabase.co https://*.licdn.com data: blob:;"
```

---

## Security Strengths (Commendations)

This codebase demonstrates excellent security practices:

1. ‚úÖ **No `dangerouslySetInnerHTML`** anywhere in the codebase
2. ‚úÖ **Protocol validation** on all user-provided URLs
3. ‚úÖ **Strict YouTube video ID validation** with regex
4. ‚úÖ **Magic number file validation** prevents file type spoofing
5. ‚úÖ **Markdown-only rendering** (no HTML injection possible)
6. ‚úÖ **Filename sanitization** on uploads
7. ‚úÖ **CSP headers** block most XSS vectors
8. ‚úÖ **No eval() or Function()** usage
9. ‚úÖ **Input length validation** on all fields
10. ‚úÖ **react-markdown without rehypeRaw** (HTML disabled)

---

## Test Cases for Verification

To verify XSS protections, attempt these attacks:

### Story Content (Should be safe ‚úÖ)
```markdown
<script>alert('xss')</script>
<img src=x onerror=alert('xss')>
[link](javascript:alert('xss'))
[YouTube](javascript:alert('xss'))
```

### User Name (Currently accepted ‚ö†Ô∏è)
```
<img src=x onerror=alert(document.cookie)>
```

### Profile Photo URL (Currently accepted ‚ö†Ô∏è)
```
data:image/svg+xml,<svg onload=alert('xss')>
```

---

## Conclusion

**Overall Security Grade: B+**

This codebase has **strong XSS defenses** with markdown-only rendering, protocol validation, and CSP headers. The two medium-severity issues (user names and bio/headline) are **not currently exploitable** due to React's automatic escaping, but should be addressed as defense-in-depth measures.

**No critical or high-severity XSS vulnerabilities exist.**

The developers have clearly prioritized security with multiple validation layers. Implementing the recommended fixes will raise the grade to an **A**.
