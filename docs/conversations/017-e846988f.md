# Conversation: bright-splashing-hammock

**Session ID:** `ed53f46a-1264-4cf5-bd8c-07aba30981cd`
**Agent ID:** `e846988f`
**Started:** 2025-11-30T03:44:29.380Z
**Ended:** 2025-11-30T03:45:40.990Z
**Duration:** 1 minutes

---

## ü§ñ Assistant
*9:44:29 PM*

I'll explore the authentication implementation in this codebase. Let me start by examining the structure and finding the relevant files.

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio -type f -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.json" | grep -E "(auth|supabase)" | head -20
```


**Tool: Glob**
Pattern: `**/src/features/auth/**`


**Tool: Glob**
Pattern: `**/src/**/*.ts`


## üë§ User
*9:44:30 PM*

**Result:**
```
/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx
/Users/ryan/projects/level2bio/src/features/auth/index.ts
/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx
```

Found files:
- `/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/index.ts`
- `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`
- `/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx`


**Result:**
```
/Users/ryan/projects/level2bio/node_modules/keyv/src/index.d.ts
/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/scopes.ts
/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/sourcemap-codec.ts
/Users/ryan/projects/level2bio/node_modules/@jridgewell/gen-mapping/src/gen-mapping.ts
/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/strings.ts
/Users/ryan/projects/level2bio/node_modules/@jridgewell/remapping/src/build-sourc
...
```

Found files:
- `/Users/ryan/projects/level2bio/node_modules/keyv/src/index.d.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/scopes.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/sourcemap-codec.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/gen-mapping/src/gen-mapping.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/strings.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/remapping/src/build-source-map-tree.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/sourcemap-codec/src/vlq.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/remapping/src/remapping.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/remapping/src/source-map-tree.ts`
- `/Users/ryan/projects/level2bio/node_modules/@jridgewell/gen-mapping/src/set-array.ts`
... and 90 more


**Result:**
```
/Users/ryan/projects/level2bio/dist/assets/supabase-BiWMF4dG.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/version.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/types.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/types.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/index.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module
...
```

```
/Users/ryan/projects/level2bio/dist/assets/supabase-BiWMF4dG.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/version.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/types.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/types.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/index.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/version.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/FunctionsClient.js
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/FunctionsClient.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/helper.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/index.d.ts
/Users/ryan/projects/level2bio/node_modules/@supabase/functions-js/dist/module/helper.js
/Users/ryan/projects
... (truncated)
```


## ü§ñ Assistant
*9:44:33 PM*

Good, I found the auth files. Let me examine them in detail along with the configuration files:

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/index.ts`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx`


## üë§ User
*9:44:34 PM*

**Result:**
```
     1‚Üíimport {
     2‚Üí  createContext,
     3‚Üí  useContext,
     4‚Üí  useEffect,
     5‚Üí  useState,
     6‚Üí  useCallback,
     7‚Üí  useMemo,
     8‚Üí  useRef,
     9‚Üí  type ReactNode,
    10‚Üí} from 'react'
    11‚Üíimport { supabase } from '@/lib/supabase'
    12‚Üíimport type { User } from '@/types'
    13‚Üí
    14‚Üí// Auth user from Supabase Auth (OAuth or email)
    15‚Üíexport interface AuthUser {
    16‚Üí  id: string
    17‚Üí  email: string | null
    18‚Üí  name: string
    19‚Üí  headline: string | null

...
```

**Result:**
```
     1‚Üí// Auth feature exports
     2‚Üíexport { AuthProvider, useAuth, type AuthUser } from './AuthContext'
     3‚Üíexport { LoginButton } from './components/LoginButton'
     4‚Üíexport { EmailAuthForm } from './components/EmailAuthForm'
     5‚Üíexport { ProtectedRoute } from './components/ProtectedRoute'
     6‚Üí

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refus
...
```

**Result:**
```
     1‚Üíimport { Navigate, useLocation } from 'react-router-dom'
     2‚Üíimport { useAuth } from '../AuthContext'
     3‚Üíimport { ROUTES } from '@/lib/constants'
     4‚Üíimport type { ReactNode } from 'react'
     5‚Üí
     6‚Üíinterface ProtectedRouteProps {
     7‚Üí  children: ReactNode
     8‚Üí}
     9‚Üí
    10‚Üíexport function ProtectedRoute({ children }: ProtectedRouteProps) {
    11‚Üí  const { authUser, isLoading } = useAuth()
    12‚Üí  const location = useLocation()
    13‚Üí
    14‚Üí  // Show loading st
...
```

**Result:**
```
     1‚Üíimport { useAuth } from '../AuthContext'
     2‚Üí
     3‚Üíinterface LoginButtonProps {
     4‚Üí  className?: string
     5‚Üí}
     6‚Üí
     7‚Üíexport function LoginButton({ className = '' }: LoginButtonProps) {
     8‚Üí  const { signInWithLinkedIn, isLoading, error } = useAuth()
     9‚Üí
    10‚Üí  const handleClick = async () => {
    11‚Üí    try {
    12‚Üí      await signInWithLinkedIn()
    13‚Üí    } catch {
    14‚Üí      // Error is already set in context
    15‚Üí    }
    16‚Üí  }
    17‚Üí
    18‚Üí  re
...
```

**Result:**
```
     1‚Üíimport { useState, useId } from 'react'
     2‚Üíimport { useAuth } from '../AuthContext'
     3‚Üí
     4‚Üí// Password strength validation
     5‚Üíconst MIN_PASSWORD_LENGTH = 12
     6‚Üíconst PASSWORD_REQUIREMENTS = {
     7‚Üí  minLength: MIN_PASSWORD_LENGTH,
     8‚Üí  hasUppercase: /[A-Z]/,
     9‚Üí  hasLowercase: /[a-z]/,
    10‚Üí  hasNumber: /[0-9]/,
    11‚Üí}
    12‚Üí
    13‚Üífunction validatePassword(password: string): { isValid: boolean; message: string } {
    14‚Üí  if (password.length < PASSWOR
...
```

## ü§ñ Assistant
*9:44:36 PM*

Now let me look at the Supabase configuration and the User type:

**Tool: Glob**
Pattern: `**/lib/supabase*`


**Tool: Glob**
Pattern: `**/types/**`


## üë§ User
*9:44:37 PM*

**Result:**
```
/Users/ryan/projects/level2bio/src/types/index.ts
/Users/ryan/projects/level2bio/src/types/database.ts
```

Found files:
- `/Users/ryan/projects/level2bio/src/types/index.ts`
- `/Users/ryan/projects/level2bio/src/types/database.ts`


**Result:**
```
/Users/ryan/projects/level2bio/src/lib/supabase.ts
```

Found files:
- `/Users/ryan/projects/level2bio/src/lib/supabase.ts`


## ü§ñ Assistant
*9:44:39 PM*

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/lib/supabase.ts`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/index.ts`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/types/database.ts`


## üë§ User
*9:44:40 PM*

**Result:**
```
     1‚Üíimport { createClient } from '@supabase/supabase-js'
     2‚Üíimport type { Database } from '../types/database'
     3‚Üí
     4‚Üíconst supabaseUrl = import.meta.env.VITE_SUPABASE_URL
     5‚Üíconst supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY
     6‚Üí
     7‚Üíif (!supabaseUrl || !supabaseAnonKey) {
     8‚Üí  throw new Error('Missing Supabase environment variables')
     9‚Üí}
    10‚Üí
    11‚Üíexport const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
    12‚Üí  auth: {
  
...
```

**Result:**
```
     1‚Üíexport * from './database'
     2‚Üí

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>

```

**Result:**
```
     1‚Üí// Database types - will be generated from Supabase CLI in production
     2‚Üí// For now, manually defined based on our schema
     3‚Üí
     4‚Üíexport type Json =
     5‚Üí  | string
     6‚Üí  | number
     7‚Üí  | boolean
     8‚Üí  | null
     9‚Üí  | { [key: string]: Json | undefined }
    10‚Üí  | Json[]
    11‚Üí
    12‚Üíexport interface Database {
    13‚Üí  public: {
    14‚Üí    Tables: {
    15‚Üí      users: {
    16‚Üí        Row: {
    17‚Üí          id: string
    18‚Üí          auth_id: string | null
  
...
```

## ü§ñ Assistant
*9:44:42 PM*

Now let me check for environment variables configuration and any additional auth-related setup:

**Tool: Glob**
Pattern: `.env*`


**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio -name "*.env*" -type f 2>/dev/null | grep -v node_modules
```


**Tool: Grep**
Search: `VITE_SUPABASE|provider.*oauth|linkedin`


## üë§ User
*9:44:44 PM*

**Result:**
```
Found 4 files
src/types/database.ts
src/features/auth/AuthContext.tsx
src/lib/supabase.ts
src/vite-env.d.ts
```

Found files:
- `src/types/database.ts`
- `src/features/auth/AuthContext.tsx`
- `src/lib/supabase.ts`
- `src/vite-env.d.ts`


**Result:**
```
/Users/ryan/projects/level2bio/.env
/Users/ryan/projects/level2bio/.env.example
```

Found files:
- `/Users/ryan/projects/level2bio/.env`
- `/Users/ryan/projects/level2bio/.env.example`


**Result:**
```
/Users/ryan/projects/level2bio/.env
/Users/ryan/projects/level2bio/.env.example
```

```
/Users/ryan/projects/level2bio/.env
/Users/ryan/projects/level2bio/.env.example
```


## ü§ñ Assistant
*9:44:46 PM*

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/.env.example`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/vite-env.d.ts`


## üë§ User
*9:44:46 PM*

**Result:**
```
     1‚Üí# ============================================================================
     2‚Üí# ENVIRONMENT VARIABLES
     3‚Üí# ============================================================================
     4‚Üí# Copy this file to .env and fill in your values
     5‚Üí#
     6‚Üí# ‚ö†Ô∏è  SECURITY WARNING:
     7‚Üí# All variables prefixed with VITE_ are PUBLIC and bundled into client code.
     8‚Üí# Never use VITE_ prefix for secrets, API keys, or sensitive data.
     9‚Üí# ==================================
...
```

**Result:**
```
     1‚Üí/// <reference types="vite/client" />
     2‚Üí
     3‚Üíinterface ImportMetaEnv {
     4‚Üí  readonly VITE_SUPABASE_URL: string
     5‚Üí  readonly VITE_SUPABASE_ANON_KEY: string
     6‚Üí  readonly VITE_USE_MOCK_AUTH: string
     7‚Üí}
     8‚Üí
     9‚Üíinterface ImportMeta {
    10‚Üí  readonly env: ImportMetaEnv
    11‚Üí}
    12‚Üí

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But 
...
```

## ü§ñ Assistant
*9:44:48 PM*

Let me check the App.tsx or main router to see how auth is integrated:

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio/src -name "App.tsx" -o -name "main.tsx" -o -name "index.tsx" | grep -v node_modules | head -5
```


## üë§ User
*9:44:49 PM*

**Result:**
```
/Users/ryan/projects/level2bio/src/App.tsx
/Users/ryan/projects/level2bio/src/main.tsx
```

```
/Users/ryan/projects/level2bio/src/App.tsx
/Users/ryan/projects/level2bio/src/main.tsx
```


## ü§ñ Assistant
*9:44:51 PM*

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/App.tsx`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/main.tsx`


## üë§ User
*9:44:51 PM*

**Result:**
```
     1‚Üíimport { lazy, Suspense } from 'react'
     2‚Üíimport { BrowserRouter, Routes, Route } from 'react-router-dom'
     3‚Üíimport { QueryClient, QueryClientProvider } from '@tanstack/react-query'
     4‚Üíimport { AuthProvider, ProtectedRoute } from '@/features/auth'
     5‚Üíimport { ErrorBoundary } from '@/components/ErrorBoundary'
     6‚Üíimport { ToastProvider } from '@/components/Toast'
     7‚Üíimport { ROUTES } from '@/lib/constants'
     8‚Üí
     9‚Üí// Lazy load pages for code splitting
    10‚Üíc
...
```

**Result:**
```
     1‚Üíimport { StrictMode } from 'react'
     2‚Üíimport { createRoot } from 'react-dom/client'
     3‚Üíimport './index.css'
     4‚Üíimport App from './App.tsx'
     5‚Üí
     6‚ÜícreateRoot(document.getElementById('root')!).render(
     7‚Üí  <StrictMode>
     8‚Üí    <App />
     9‚Üí  </StrictMode>,
    10‚Üí)
    11‚Üí

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse t
...
```

## ü§ñ Assistant
*9:44:54 PM*

Let me check if there are any utility functions or hooks related to auth:

**Tool: Bash**
```bash
find /Users/ryan/projects/level2bio/src -type f \( -name "*.ts" -o -name "*.tsx" \) | xargs grep -l "auth\|Auth" | head -15
```


## üë§ User
*9:45:17 PM*

**Result:**
```
/Users/ryan/projects/level2bio/src/App.tsx
/Users/ryan/projects/level2bio/src/types/database.ts
/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx
/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx
/Users/ryan/projects/level2bio/src/features/auth/index.ts
/Users/ryan/projects/level2bio/src/features/stor
...
```

```
/Users/ryan/projects/level2bio/src/App.tsx
/Users/ryan/projects/level2bio/src/types/database.ts
/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/ProtectedRoute.tsx
/Users/ryan/projects/level2bio/src/features/auth/components/LoginButton.tsx
/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx
/Users/ryan/projects/level2bio/src/features/auth/index.ts
/Users/ryan/projects/level2bio/src/features/stories/components/StoryEditor.tsx
/Users/ryan/projects/level2bio/src/features/stories/hooks/useAssetUpload.ts
/Users/ryan/projects/level2bio/src/features/stories/hooks/useStories.ts
/Users/ryan/projects/level2bio/src/lib/supabase.ts
/Users/ryan/projects/level2bio/src/pages/Dashboard.tsx
/Users/ryan/projects/level2bio/src/pages/StoryEditorPage.tsx
/Users/ryan/projects/level2bio/src/pages/Home.tsx
```


## ü§ñ Assistant
*9:45:19 PM*

Let me check the Home and Dashboard pages to see how auth is used:

**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/pages/Home.tsx`


**Tool: Read**
Reading: `/Users/ryan/projects/level2bio/src/pages/Dashboard.tsx`


## üë§ User
*9:45:20 PM*

**Result:**
```
     1‚Üíimport { Navigate } from 'react-router-dom'
     2‚Üíimport { useAuth, LoginButton, EmailAuthForm } from '@/features/auth'
     3‚Üíimport { ROUTES } from '@/lib/constants'
     4‚Üí
     5‚Üí// Enable email auth (alternative to LinkedIn OAuth)
     6‚Üíconst emailAuthEnabled = import.meta.env.VITE_EMAIL_AUTH_ENABLED === 'true'
     7‚Üí
     8‚Üíexport default function Home() {
     9‚Üí  const { authUser, isLoading } = useAuth()
    10‚Üí
    11‚Üí  // If already logged in, redirect to dashboard
    12‚Üí  i
...
```

**Result:**
```
     1‚Üíimport { useAuth } from '@/features/auth'
     2‚Üíimport { StoryList, useStories } from '@/features/stories'
     3‚Üíimport { ProfileManager } from '@/features/profile'
     4‚Üí
     5‚Üíexport default function Dashboard() {
     6‚Üí  const { user, authUser, signOut } = useAuth()
     7‚Üí  const { data: stories } = useStories(user?.id)
     8‚Üí
     9‚Üí  const allStories = stories ?? []
    10‚Üí
    11‚Üí  return (
    12‚Üí    <div className="min-h-screen bg-gray-50">
    13‚Üí      <div className="max-
...
```

## ü§ñ Assistant
*9:45:40 PM*

Perfect! Now I have a complete picture. Let me create a comprehensive summary of the authentication implementation.

## Authentication Architecture Summary

Based on my exploration of the codebase, here's a detailed breakdown of the current authentication implementation:

---

### **1. Auth Setup Overview**

The authentication system is built on **Supabase Auth** with a hybrid approach supporting both **LinkedIn OAuth** (production) and **Email/Password authentication** (development/testing).

**Key Files:**
- `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx` - Main auth logic
- `/Users/ryan/projects/level2bio/src/lib/supabase.ts` - Supabase client initialization
- `/Users/ryan/projects/level2bio/src/types/database.ts` - Database schema and types

---

### **2. Supabase Configuration**

**File:** `/Users/ryan/projects/level2bio/src/lib/supabase.ts`

```typescript
export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
  auth: {
    autoRefreshToken: true,
    persistSession: true,
    detectSessionInUrl: true,  // Auto-detects tokens in URL for OAuth callbacks
  },
})
```

**Environment Variables** (`.env.example`):
- `VITE_SUPABASE_URL` - Supabase project URL
- `VITE_SUPABASE_ANON_KEY` - Public anon key (safe for client)
- `VITE_EMAIL_AUTH_ENABLED` - Toggle for email auth (defaults to OAuth only)

**Security Note:** LinkedIn OAuth credentials are stored server-side in Supabase, NOT in client code.

---

### **3. OAuth Setup**

**LinkedIn OAuth Implementation:**

```typescript
const signInWithLinkedIn = useCallback(async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: 'linkedin_oidc',
    options: {
      redirectTo: `${window.location.origin}/dashboard`,
    },
  })
  // ...
}, [])
```

- Uses **LinkedIn OIDC** provider (configured in Supabase Dashboard)
- Redirects to `/dashboard` after successful login
- User metadata (name, headline, profile photo) extracted from LinkedIn

---

### **4. Auth User Schema (AuthUser Type)**

**File:** `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`

```typescript
export interface AuthUser {
  id: string              // Supabase Auth UID
  email: string | null    // From auth provider
  name: string            // Extracted from OAuth metadata or email prefix
  headline: string | null // LinkedIn headline (if available)
  profilePhotoUrl: string | null  // Avatar URL from provider
}
```

**Data Flow:**
1. OAuth provider returns user metadata
2. `sessionToAuthUser()` helper extracts and normalizes fields
3. Helper validates types and provides fallbacks (e.g., email prefix as name)

---

### **5. User Database Schema**

**File:** `/Users/ryan/projects/level2bio/src/types/database.ts`

```typescript
// Users table
{
  id: string                    // Primary key (Supabase Auth UID)
  auth_id: string | null        // Legacy field
  linkedin_id: string           // OAuth provider ID or 'auth_[id]' fallback
  email: string | null
  name: string
  headline: string | null
  bio: string | null
  profile_photo_url: string | null
  created_at: string
  updated_at: string
}
```

**Relations:**
- `work_stories` table (foreign key: `user_id`)
- `share_links` table (foreign key: `user_id`)
- `profiles` table (public profiles, foreign key: `user_id`)

---

### **6. Auth Flow Architecture**

**Complete Flow Diagram:**

```
Login/Signup Attempt
        ‚Üì
[AuthContext] ‚Üí signIn/signUp/signInWithLinkedIn
        ‚Üì
Supabase Auth API
        ‚Üì
[onAuthStateChange listener] detects session change
        ‚Üì
sessionToAuthUser() ‚Üí converts to AuthUser
        ‚Üì
syncUserRecord() ‚Üí fetch/create/update in 'users' table
        ‚Üì
Set { authUser, user } in context
        ‚Üì
ProtectedRoute checks authUser
        ‚Üì
Route permission granted ‚Üí Dashboard
```

**Key Components:**

| Component | File | Purpose |
|-----------|------|---------|
| **AuthProvider** | AuthContext.tsx | Context provider, manages auth state |
| **useAuth()** | AuthContext.tsx | Hook to access auth context |
| **ProtectedRoute** | ProtectedRoute.tsx | Guard component, redirects to home if not authenticated |
| **LoginButton** | LoginButton.tsx | LinkedIn OAuth button |
| **EmailAuthForm** | EmailAuthForm.tsx | Email/password form (optional) |

---

### **7. Email/Password Authentication**

**File:** `/Users/ryan/projects/level2bio/src/features/auth/components/EmailAuthForm.tsx`

**Password Requirements:**
- Minimum 12 characters
- At least one uppercase letter
- At least one lowercase letter
- At least one number

**Features:**
- Toggle between Sign In and Sign Up modes
- Form validation before submission
- Email confirmation disabled (immediate signup)
- Error messages with security sanitization

---

### **8. Session & Token Management**

**File:** `/Users/ryan/projects/level2bio/src/lib/supabase.ts`

```typescript
auth: {
  autoRefreshToken: true,   // Automatically refresh expired tokens
  persistSession: true,      // Store session in localStorage
  detectSessionInUrl: true,  // Handle OAuth redirect tokens
}
```

**Security Features:**
- Automatic token refresh via `TOKEN_REFRESHED` event
- Session persistence across browser restarts
- Automatic logout on `SIGNED_OUT` event
- Debouncing duplicate sync operations with `isSyncingRef`

---

### **9. User Sync Logic**

**File:** `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`

The `syncUserRecord()` function handles a 3-step sync process:

```
Step 1: Check if user exists by auth ID
   ‚Üì (if found, return)
Step 2: Check if user exists by email (handles auth recreation)
   ‚Üì (if found, update ID and return)
Step 3: Create new user record with OAuth data
```

**Smart Handling:**
- Handles edge case where auth user is recreated (new ID, same email)
- Prevents duplicate DB syncs using `isSyncingRef` ref
- Defers DB operations to avoid blocking auth callbacks
- Component unmount safety with `isMountedRef`

---

### **10. Error Handling & Security**

**File:** `/Users/ryan/projects/level2bio/src/features/auth/AuthContext.tsx`

```typescript
function getPublicErrorMessage(error): string {
  // Email enumeration prevention
  // "already registered" ‚Üí "may already exist"
  
  // Credential protection
  // "invalid login" ‚Üí "invalid email or password"
  
  // Internal error hiding
  // "database error" ‚Üí "Something went wrong"
}
```

**Error Sanitization:**
- Prevents email enumeration attacks
- Hides database/internal errors
- User-friendly messages for common errors

---

### **11. App Integration**

**File:** `/Users/ryan/projects/level2bio/src/App.tsx`

```typescript
<ErrorBoundary>
  <QueryClientProvider>
    <AuthProvider>  {/* Auth context wraps entire app */}
      <ToastProvider>
        <BrowserRouter>
          <Routes>
            <Route path="/" element={<Home />} />
            <Route path="/dashboard" element={
              <ProtectedRoute><Dashboard /></ProtectedRoute>
            } />
            {/* Other protected routes... */}
          </Routes>
        </BrowserRouter>
      </ToastProvider>
    </AuthProvider>
  </QueryClientProvider>
</ErrorBoundary>
```

**Protected Routes:**
- `/dashboard` - Requires authentication
- `/stories/new` - Requires authentication  
- `/stories/:id/edit` - Requires authentication
- `/profile/:token` - Public (no auth required)
- `/` - Public (redirects to dashboard if authenticated)

---

### **12. Current Features**

‚úÖ LinkedIn OAuth login  
‚úÖ Email/password signup and signin (optional)  
‚úÖ Automatic session persistence  
‚úÖ Token auto-refresh  
‚úÖ User profile sync to database  
‚úÖ Protected routes  
‚úÖ Error sanitization  
‚úÖ Email validation  
‚úÖ Strong password validation  
‚úÖ Sign out functionality  

---

### **Key Architectural Decisions**

1. **Dual Auth Providers**: OAuth for production, email for development flexibility
2. **Separate Auth & User Records**: Supabase Auth handles authentication; custom `users` table stores app-specific profile data
3. **Async User Sync**: Non-blocking user record creation/update after auth
4. **Safety Refs**: Prevents race conditions and unmount-related state updates
5. **Public Error Messages**: Security-first error handling prevents information leakage
