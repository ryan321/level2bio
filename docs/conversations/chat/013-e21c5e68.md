# Chat: bright-splashing-hammock

**Started:** 2025-11-30T02:22:20.775Z
**Ended:** 2025-11-30T02:23:19.419Z
**Duration:** 1 minutes

---

**ü§ñ Assistant** *8:22:20 PM*

I'll explore the codebase to understand the current Supabase storage configuration and file handling. Let me start by examining the key files.

**ü§ñ Assistant** *8:22:24 PM*

Now let me examine the key files to understand the structure:

**ü§ñ Assistant** *8:22:27 PM*

Now let me look at the source code structure to find any upload components or hooks:

**ü§ñ Assistant** *8:22:30 PM*

Let me examine the key files related to stories and profiles:

**ü§ñ Assistant** *8:22:33 PM*

Let me check the supabase client configuration and look for any profile-related code:

**ü§ñ Assistant** *8:22:36 PM*

Let me check the other migrations to understand the complete schema:

**ü§ñ Assistant** *8:22:45 PM*

Let me get the actual root package.json:

**ü§ñ Assistant** *8:22:48 PM*

Now let me check for any existing docs to understand the project better:

**ü§ñ Assistant** *8:22:51 PM*

Let me check the spec to understand better what this project does:

**ü§ñ Assistant** *8:22:54 PM*

Perfect! Now let me check one more file to understand the current story card implementation:

**ü§ñ Assistant** *8:22:56 PM*

Now let me check the PublicProfilePage to see how stories are displayed to viewers:

**ü§ñ Assistant** *8:23:19 PM*

Perfect! Now I have all the information I need. Let me create a comprehensive summary document.

## Summary: Supabase Storage Configuration & File Upload Analysis

Based on my exploration of the Level2.bio codebase, here's what I found regarding file uploads and video handling:

---

### CURRENT STATE

#### 1. **Supabase Storage Configuration**
**File**: `/Users/ryan/projects/level2bio/supabase/config.toml`

Storage is **enabled** with the following config:
```toml
[storage]
enabled = true
file_size_limit = "50MiB"
```

**Current status**: Storage is configured but **NOT YET IMPLEMENTED** in the application code. No buckets are created, and no upload components exist.

---

#### 2. **Video URL Field (Current Implementation)**
**Database**: `/Users/ryan/projects/level2bio/supabase/migrations/001_initial_schema.sql`

The `work_stories` table includes:
```sql
video_url text
```

**Current usage**:
- Stores **YouTube URLs only** (extracted via `extractYouTubeId()`)
- No file uploads to Supabase Storage
- Video displayed via YouTube embed iframe in the public profile viewer

**Files using video_url**:
- `/Users/ryan/projects/level2bio/src/features/stories/components/StoryEditor.tsx` (lines 23-184)
  - Accepts YouTube URLs as text input
  - Shows live preview
  - Auto-saves with debounce
- `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx` (lines 133-159)
  - `VideoPlayer` component extracts YouTube ID and embeds
  - Returns `null` if URL doesn't parse as YouTube

**YouTube utilities**: `/Users/ryan/projects/level2bio/src/lib/youtube.ts`
- `extractYouTubeId()` - parses YouTube URLs
- `getYouTubeEmbedUrl()` - builds embed URL

---

#### 3. **Story Response Structure**
**File**: `/Users/ryan/projects/level2bio/src/types/database.ts` (lines 260-280)

```typescript
export interface ProjectResponses {
  problem?: string
  approach?: string
  outcome?: string
  learnings?: string
}

export interface RoleHighlightResponses {
  role?: string
  impact?: string
  challenges?: string
}

export interface LessonsLearnedResponses {
  situation?: string
  lesson?: string
  application?: string
}

export type StoryResponses = ProjectResponses | RoleHighlightResponses | LessonsLearnedResponses
```

**Storage in database**:
- Stored as JSONB in `work_stories.responses` field
- Each prompt response is plain text (markdown-compatible)
- Rendered with `react-markdown` in public viewer

---

#### 4. **Existing File Upload Components**
**Result**: **NONE EXIST**

No file upload:
- No `<input type="file">` components
- No upload hooks or mutations
- No Supabase Storage API calls
- No file size validation UI
- No upload progress indicators

---

#### 5. **Project Tech Stack**
**File**: `/Users/ryan/projects/level2bio/package.json`

Key dependencies:
- `@supabase/supabase-js` v2.86.0 - Has full Storage API support
- `@tanstack/react-query` v5.90.11 - For mutations
- `react` v19.2.0
- `tailwindcss` v4.1.17 - For styling

---

### WHAT WOULD NEED TO BE ADDED FOR FILE UPLOADS

#### A. **Database Changes**

1. **Video Storage Field** (in `work_stories` table):
   ```sql
   -- Add to existing table
   video_file_url text,  -- Path to video in Supabase Storage
   video_file_name text,  -- Original filename (for reference)
   video_file_size int,   -- Size in bytes
   ```
   OR modify existing `video_url` to handle both YouTube and uploaded files

2. **Storage Bucket Creation** (migration):
   ```sql
   -- Create bucket via Supabase JavaScript client or SQL
   INSERT INTO storage.buckets (id, name, public) 
   VALUES ('story-videos', 'story-videos', false);
   ```

3. **RLS Policies for Storage**:
   - Users can upload to `story-videos/{user_id}/*`
   - Users can delete their own files
   - Public viewers can read files via public profile link

---

#### B. **Frontend Components Needed**

1. **Upload Hook** - `/src/features/stories/hooks/useVideoUpload.ts`
   - Uses Supabase Storage API: `supabase.storage.from('story-videos').upload()`
   - Handle progress tracking
   - Handle errors (size limit, network issues)
   - Return signed URL for display

2. **Upload UI Component** - `/src/features/stories/components/VideoUploadArea.tsx`
   - File input with drag-drop
   - Preview before upload
   - Progress bar
   - File size validation (50MB limit from config)
   - Success/error states

3. **Modified StoryEditor** - `/src/features/stories/components/StoryEditor.tsx`
   - Replace YouTube-only input with toggle: "YouTube" vs "Upload Video"
   - Conditional rendering of upload vs URL input
   - Handle cleanup of old files on update

4. **Video Display Logic** - `/src/pages/PublicProfilePage.tsx`
   - Detect video type: YouTube vs uploaded file
   - Route to appropriate player (iframe vs HTML5 video)
   - Use signed URLs for uploaded videos

---

#### C. **File Upload Hook Structure**

```typescript
// Pseudo-code for what's needed
interface UseVideoUploadOptions {
  maxSize: number // bytes
  onProgress?: (percentage: number) => void
}

export function useVideoUpload(options?: UseVideoUploadOptions) {
  // Upload to supabase.storage.from('story-videos').upload()
  // Generate signed URL (valid for 1 year or permanent for public)
  // Return { url, fileName, size, status }
}
```

---

#### D. **Story Type Changes**

Current type in `/src/types/database.ts`:
```typescript
video_url: string | null  // Currently YouTube only
```

Should become:
```typescript
video_url: string | null  // YouTube URL or signed Storage URL
video_type: 'youtube' | 'uploaded' | null
video_file_id?: string    // Reference to storage file for deletion
```

---

### SPEC REQUIREMENTS (from `/docs/spec.md`)

**Feature 1.4 (Work Story Creation) - Acceptance Criteria**:
```
- [ ] Candidate can optionally upload a video walkthrough
```

**Error states documented**:
- "Video upload fails: Show 'Upload failed ‚Äî try again or skip for now'; allow saving without video"
- "Session expires mid-edit: Auto-save drafts; restore on next login"

**Flow step 4**:
> "Optionally uploads video"

---

### CURRENT GAPS

| Item | Status | Impact |
|------|--------|--------|
| Storage bucket created | ‚ùå No | Blocking |
| Upload hook/mutation | ‚ùå No | Blocking |
| Upload UI component | ‚ùå No | Blocking |
| File size validation | ‚ùå No | UX issue |
| Signed URL generation | ‚ùå No | Blocking |
| Public viewer video display | ‚ö†Ô∏è Partial | Only YouTube works |
| Delete uploaded video on story delete | ‚ùå No | Storage leak |
| Error handling for uploads | ‚ùå No | UX issue |
| Progress indication | ‚ùå No | UX issue |

---

### RECOMMENDED IMPLEMENTATION PRIORITY

1. **Create storage bucket** (migration)
2. **Add RLS policies** (migration)
3. **Update database types** (`types/database.ts`)
4. **Build upload hook** (`useVideoUpload.ts`)
5. **Build upload component** (`VideoUploadArea.tsx`)
6. **Update story mutations** to handle file cleanup
7. **Update StoryEditor** to support both YouTube and uploads
8. **Update PublicProfilePage** viewer to detect video type

---

### KEY FILE PATHS (absolute)

- Supabase config: `/Users/ryan/projects/level2bio/supabase/config.toml`
- Initial schema: `/Users/ryan/projects/level2bio/supabase/migrations/001_initial_schema.sql`
- Database types: `/Users/ryan/projects/level2bio/src/types/database.ts`
- Story editor: `/Users/ryan/projects/level2bio/src/features/stories/components/StoryEditor.tsx`
- Public viewer: `/Users/ryan/projects/level2bio/src/pages/PublicProfilePage.tsx`
- Story mutations: `/Users/ryan/projects/level2bio/src/features/stories/hooks/useStoryMutations.ts`
- Supabase client: `/Users/ryan/projects/level2bio/src/lib/supabase.ts`
